
# Custom Instruction: HAR File Processing for API Test Generation

## Overview
This instruction defines how to process HAR (HTTP Archive) files generated by Playwright to create API tests that follow our framework patterns.

## HAR File Structure Understanding

### Key Properties to Extract
- **Request Method**: `entries[].request.method` (GET, POST, PUT, DELETE)
- **Request URL**: `entries[].request.url` 
- **Request Headers**: `entries[].request.headers[]`
- **Request Body**: `entries[].request.postData.text` (JSON string)
- **Query Parameters**: `entries[].request.queryString[]`
- **Response Status**: `entries[].response.status`
- **Response Body**: `entries[].response.content.text` (JSON string)


## Request Processing Patterns

### 1. Request Identification
```typescript
// Pattern for processing each API request
const method = entry.request.method
const url = entry.request.url
const body = entry.request.postData?.text ? JSON.parse(entry.request.postData.text) : null
const status = entry.response.status
const response = JSON.parse(entry.response.content.text)
```

### 2. URL Path Extraction
```typescript
// Extract API path from full URL
// From: "https://conduit-api.bondaracademy.com/api/articles"
// To: "/articles"
const apiPath = new URL(url).pathname.replace('/api', '')
```

### 3. Query Parameters Processing
```typescript
// Convert queryString array to params object
const params = {}
entry.request.queryString.forEach(param => {
    params[param.name] = param.value
})
```

## Response Data Extraction Rules

### Important Response Fields to Track
- **Resource IDs**: `article.slug`, `comment.id`, `user.id`
- **Dynamic Values**: Any field that might be used in subsequent requests

### Variable Naming Convention
```typescript
// Extract and store important values with descriptive names
const authToken = loginResponse.user.token
const articleSlug = createArticleResponse.article.slug
const commentId = createCommentResponse.comment.id
```

## Test Generation Patterns

### 1. Test Structure
```typescript
import { test } from '../utils/fixtures';
import { expect } from '../utils/custom-expect';

test('HAR Flow - [Description]', async ({ api }) => {
    // Sequential API calls based on HAR file order
});
```

### 2. Request Translation
```typescript
// HAR entry to API test conversion
const response = await api
    .path('extracted-path')
    .body(extracted-body)
    .params(extracted-params)
    .methodRequest(expected-status)

// Add schema validation
await expect(response).shouldMatchSchema('folder', 'METHOD_endpoint', true)

// Extract important values for next requests
const extractedValue = response.field.subfield
```

### 3. Authentication Handling
- **Skip** login request because authentication is handled by fixtures
- **Remove** authorization headers from HAR processing

### 4. Dynamic Value Usage
```typescript
// Example: Create article, then get it by slug
const createResponse = await api
    .path('/articles')
    .body(articleData)
    .postRequest(201)
const articleSlug = createResponse.article.slug

const getResponse = await api
    .path(`/articles/${articleSlug}`)
    .getRequest(200)
```

### 5. Test Data Generation
For the API requests values, use Faker JS library instead of hardcoded values from HAR file

```typescript
// Example: Create article, with random title
const randomTitle = faker.lorem.sentence(5)
articleRequest.article.title = randomTitle
const createArticleResponse = await api
    .path('/articles')
    .body(articleRequest)
    .postRequest(201)
```

## Test Quality Standards

### Required Elements
1. **Schema Validation**: Every response must have `shouldMatchSchema()`
2. **Response Extraction**: Store values needed for subsequent requests
3. **Descriptive Variables**: Use meaningful names for extracted values
4. **Sequential Flow**: Maintain the exact order from HAR file
5. **Error Handling**: Use expected status codes from HAR

### Test Naming
- **Format**: `HAR Flow - [Main Action or Sequence]`
- **Examples**: 
  - `HAR Flow - Create Article with Comments`
  - `HAR Flow - User Registration and Profile Update`

### Code Organization
```typescript
test('HAR Flow - Article Lifecycle', async ({ api }) => {
    // Step 1: Create article
    const createResponse = await api...
    await expect(createResponse).shouldMatchSchema(...)
    const articleSlug = createResponse.article.slug

    // Step 2: Get article
    const getResponse = await api...
    await expect(getResponse).shouldMatchSchema(...)

    // Step 3: Add comment
    const commentResponse = await api...
    await expect(commentResponse).shouldMatchSchema(...)
    
    // Additional steps following HAR sequence...
});
```